

### Очищаем правила

**Если хотим настроить только свои правила, сбрасываем всё предыдущее**

```bash
sudo iptables -F
sudo iptables -X
sudo iptables -t nat -F
sudo iptables -t nat -X
sudo iptables -t mangle -F
sudo iptables -t mangle -X
```

### Добавляем новые правила

**Разрешаем loopback и уже установленные соединения**

```bash
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
```

**Разрешаем SSH**

```bash
sudo iptables -A INPUT -p tcp --dport 44916 -m conntrack --ctstate NEW -j ACCEPT
```

### Устанавливаем политики

**Все входящие блокируются (кроме разрешенных правилами)**

```bash
sudo iptables -A INPUT -j DROP
```

**Запрещаем форвардинг**

```bash
sudo iptables -P FORWARD DROP
```

**Все исходящие разрешены**

```bash
sudo iptables -A OUTPUT -j ACCEPT
```

### Проверка

**Проверяем правила**

```bash
sudo iptables -L -v -n
```

**Результат**

```
Chain INPUT (policy DROP 8604 packets, 676K bytes)
 pkts bytes target     prot opt in     out     source               destination         
    6   312 ACCEPT     6    --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:44916 ctstate NEW
    0     0 ACCEPT     0    --  lo     *       0.0.0.0/0            0.0.0.0/0           
 1007  125K ACCEPT     0    --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED

Chain FORWARD (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 7482 packets, 543K bytes)
 pkts bytes target     prot opt in     out     source               destination         
```

### Сохраняем правила

**Сохраняем правила и настраиваем их загрузку после перезапуска ОС.**

```bash
sudo iptables-save | sudo tee /etc/iptables/rules.v4
```

```rules.v4
# Generated by iptables-save v1.8.9 (nf_tables) on Tue Sep  9 16:00:42 2025
*filter
:INPUT DROP [206:9188]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [296:56267]
-A INPUT -i lo -j ACCEPT
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --dport 44916 -m conntrack --ctstate NEW -j ACCEPT
COMMIT
# Completed on Tue Sep  9 16:00:42 2025
# Generated by iptables-save v1.8.9 (nf_tables) on Tue Sep  9 16:00:42 2025
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
# Completed on Tue Sep  9 16:00:42 2025
```

**Устанавливаем netfilter-persistent**

```bash
sudo apt update
sudo apt install iptables-persistent -y
```

**Включаем netfilter-persistent в автозагрузку**

```bash
sudo systemctl enable netfilter-persistent
```

**На всякий случай запустим, чтобы проверить считался ли rules.v4**

```bash
sudo systemctl start netfilter-persistent
```
